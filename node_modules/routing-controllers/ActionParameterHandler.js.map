{"version":3,"sources":["../../src/ActionParameterHandler.ts"],"names":[],"mappings":"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","file":"ActionParameterHandler.js","sourcesContent":["import {plainToClass} from \"class-transformer\";\nimport {validateOrReject as validate, ValidationError} from \"class-validator\";\nimport {Action} from \"./Action\";\nimport {BadRequestError} from \"./http-error/BadRequestError\";\nimport {BaseDriver} from \"./driver/BaseDriver\";\nimport {ParameterParseJsonError} from \"./error/ParameterParseJsonError\";\nimport {ParamMetadata} from \"./metadata/ParamMetadata\";\nimport {ParamRequiredError} from \"./error/ParamRequiredError\";\nimport {AuthorizationRequiredError} from \"./error/AuthorizationRequiredError\";\nimport {CurrentUserCheckerNotDefinedError} from \"./error/CurrentUserCheckerNotDefinedError\";\nimport {isPromiseLike} from \"./util/isPromiseLike\";\n\n/**\n * Handles action parameter.\n */\nexport class ActionParameterHandler<T extends BaseDriver> {\n\n    // -------------------------------------------------------------------------\n    // Constructor\n    // -------------------------------------------------------------------------\n\n    constructor(private driver: T) {\n    }\n\n    // -------------------------------------------------------------------------\n    // Public Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Handles action parameter.\n     */\n    handle(action: Action, param: ParamMetadata): Promise<any>|any {\n\n        if (param.type === \"request\")\n            return action.request;\n\n        if (param.type === \"response\")\n            return action.response;\n\n        if (param.type === \"context\")\n            return action.context;\n\n        // get parameter value from request and normalize it\n        const value = this.normalizeParamValue(this.driver.getParamFromRequest(action, param), param);\n        if (isPromiseLike(value))\n            return value.then(value => this.handleValue(value, action, param));\n\n        return this.handleValue(value, action, param);\n    }\n\n    // -------------------------------------------------------------------------\n    // Protected Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Handles non-promise value.\n     */\n    protected handleValue(value: any, action: Action, param: ParamMetadata): Promise<any>|any {\n\n        // if transform function is given for this param then apply it\n        if (param.transform)\n            value = param.transform(action, value);\n\n        // if its current-user decorator then get its value\n        if (param.type === \"current-user\") {\n            if (!this.driver.currentUserChecker)\n                throw new CurrentUserCheckerNotDefinedError();\n\n            value = this.driver.currentUserChecker(action);\n        }\n\n        // check cases when parameter is required but its empty and throw errors in this case\n        if (param.required) {\n            const isValueEmpty = value === null || value === undefined || value === \"\";\n            const isValueEmptyObject = value instanceof Object && Object.keys(value).length === 0;\n\n            if (param.type === \"body\" && !param.name && (isValueEmpty || isValueEmptyObject)) { // body has a special check and error message\n                return Promise.reject(new ParamRequiredError(action, param));\n\n            } else if (param.type === \"current-user\") { // current user has a special check as well\n\n                if (isPromiseLike(value)) {\n                    return value.then(currentUser => {\n                        if (!currentUser)\n                            return Promise.reject(new AuthorizationRequiredError(action));\n\n                        return currentUser;\n                    });\n\n                } else {\n                    if (!value)\n                        return Promise.reject(new AuthorizationRequiredError(action));\n                }\n\n            } else if (param.name && isValueEmpty) { // regular check for all other parameters // todo: figure out something with param.name usage and multiple things params (query params, upload files etc.)\n                return Promise.reject(new ParamRequiredError(action, param));\n            }\n        }\n\n        return value;\n    }\n\n    /**\n     * Normalizes parameter value.\n     */\n    protected normalizeParamValue(value: any, param: ParamMetadata): Promise<any>|any {\n        if (value === null || value === undefined)\n            return value;\n\n        switch (param.targetName) {\n            case \"number\":\n                if (value === \"\") return undefined;\n                return +value;\n\n            case \"string\":\n                return value;\n\n            case \"boolean\":\n                if (value === \"true\" || value === \"1\") {\n                    return true;\n\n                } else if (value === \"false\" || value === \"0\") {\n                    return false;\n                }\n\n                return !!value;\n\n            case \"date\":\n                const parsedDate = new Date(value);\n                if (isNaN(parsedDate.getTime())) {\n                    return Promise.reject(new BadRequestError(`${param.name} is invalid! It can't be parsed to date.`));\n                }\n                return parsedDate;\n\n            default:\n                if (value && (param.parse || param.isTargetObject)) {\n                    value = this.parseValue(value, param);\n                    value = this.transformValue(value, param);\n                    value = this.validateValue(value, param); // note this one can return promise\n                }\n        }\n        return value;\n    }\n\n    /**\n     * Parses string value into a JSON object.\n     */\n    protected parseValue(value: any, paramMetadata: ParamMetadata): any {\n        if (typeof value === \"string\") {\n            try {\n                return JSON.parse(value);\n            } catch (error) {\n                throw new ParameterParseJsonError(paramMetadata.name, value);\n            }\n        }\n\n        return value;\n    }\n\n    /**\n     * Perform class-transformation if enabled.\n     */\n    protected transformValue(value: any, paramMetadata: ParamMetadata): any {\n        if (this.driver.useClassTransformer &&\n            paramMetadata.targetType &&\n            paramMetadata.targetType !== Object &&\n            !(value instanceof paramMetadata.targetType)) {\n\n            const options = paramMetadata.classTransform || this.driver.plainToClassTransformOptions;\n            value = plainToClass(paramMetadata.targetType, value, options);\n        }\n\n        return value;\n    }\n\n    /**\n     * Perform class-validation if enabled.\n     */\n    protected validateValue(value: any, paramMetadata: ParamMetadata): Promise<any>|any {\n        const isValidationEnabled = (paramMetadata.validate instanceof Object || paramMetadata.validate === true)\n            || (this.driver.enableValidation === true && paramMetadata.validate !== false);\n        const shouldValidate = paramMetadata.targetType\n            && (paramMetadata.targetType !== Object)\n            && (value instanceof paramMetadata.targetType);\n\n        if (isValidationEnabled && shouldValidate) {\n            const options = paramMetadata.validate instanceof Object ? paramMetadata.validate : this.driver.validationOptions;\n            return validate(value, options)\n                .then(() => value)\n                .catch((validationErrors: ValidationError[]) => {\n                    const error: any = new BadRequestError(`Invalid ${paramMetadata.type}, check 'errors' property for more info.`);\n                    error.errors = validationErrors;\n                    error.paramName = paramMetadata.name; \n                    throw error;\n                });\n        }\n\n        return value;\n    }\n\n}\n"],"sourceRoot":"."}